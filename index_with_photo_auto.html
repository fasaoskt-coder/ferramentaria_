<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Ferramentaria El√©trica CA ‚Äî Vale</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
  :root { --vale-green:#1E6E43; --vale-teal:#3BA99C; --vale-dark:#0f1724; --vale-bg:#F7F9F9; --muted:#64748b; --card-shadow: 0 8px 24px rgba(15,23,36,0.06); }
  html,body{height:100%;}
  body { background: var(--vale-bg); color:var(--vale-dark); font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .vale-header { background: linear-gradient(90deg, var(--vale-green), var(--vale-teal)); color:#fff; padding:18px 0; box-shadow: 0 4px 18px rgba(0,0,0,0.08); }
  .vale-header .brand { display:flex; align-items:center; gap:1rem; }
  .vale-header img.logo { height:40px; width:auto; object-fit:contain; border-radius:6px; background:rgba(255,255,255,0.06); padding:4px; }
  #brandTitle { font-weight:700; font-size:1.15rem; letter-spacing:0.2px; }
  .site-tag { opacity:0.95; font-size:0.9rem; }
  .app-bar { background:#fff; border-bottom:1px solid #e6eef0; position:sticky; top:0; z-index:40; }
  .app-title { color: var(--vale-dark); font-weight:600; }
  .card { box-shadow: var(--card-shadow); border:0; border-radius:12px; background:#fff; }
  .tool-photo { width:72px; height:72px; object-fit:cover; border-radius:10px; }
  .status-badge { font-size:.75rem; }
  .holder-highlight { border: 2px solid rgba(59,169,156,0.15); box-shadow: 0 6px 18px rgba(59,169,156,0.06); }
  .tool-card .card-body { padding:16px; }
  .tool-meta { min-width:0; }
  .qr-print { page-break-inside: avoid; display:inline-block; margin:8px; padding:12px; border:1px dashed #cbd5e1; border-radius:8px; text-align:center; background:#fff; }
  .vale-footer { color:#475569; font-size:.9rem; }
  .small-muted { color:var(--muted); font-size:0.9rem; }
  .btn-outline-primary[disabled] { opacity:0.45; pointer-events:none; }
  @media (max-width:767px){ .container { padding-left:12px; padding-right:12px; } .vale-header img.logo { height:34px; } .tool-photo { width:56px; height:56px; } }
</style>

</head>
<body>

<!-- COMPACT WELCOME BANNER WITH AVATAR -->
<style>
  #welcomeBanner {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 50px;
    margin: 10px auto;
    background: linear-gradient(90deg, #1b6fb8 0%, #3aa8f2 100%);
    color: #fff;
    max-width: 400px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-family: "Segoe UI", sans-serif;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }
  #welcomeBanner:hover {
    transform: scale(1.02);
  }
  #welcomeBanner .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #fff;
    color: #1b6fb8;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
    flex-shrink: 0;
  }
  #welcomeBanner .name {
    font-weight: 600;
  }
  #welcomeBanner .subtitle {
    font-size: 0.8rem;
    color: #e3f3ff;
  }
</style>

<div id="welcomeBanner" style="display:none;">
  <div class="avatar" id="welcomeAvatar">U</div>
  <div class="text">
    <div>Ol√°, <span class="name" id="welcomeName"></span>!</div>
    <div class="subtitle">Bem-vindo(a) ao controle de ferramentas</div>
  </div>
</div>
<!-- /COMPACT WELCOME BANNER WITH AVATAR -->


<nav class="vale-header py-2">
<div class="container d-flex justify-content-between align-items-center">
<div class="brand">
<img alt="Vale" class="logo" id="valeLogo" src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Vale_logo.svg"/>
<strong id="brandTitle">Vale</strong>
</div>
<div class="small"><span id="siteTag">Seguran√ßa e produtividade em primeiro lugar</span></div>
</div>
</nav>
<nav class="app-bar py-2">
<div class="container d-flex justify-content-between align-items-center">
<div class="d-flex align-items-center gap-2">
<span class="badge" style="background: var(--vale-green);">MVP</span>
<h1 class="h5 mb-0 app-title">Ferramentaria El√©trica CA</h1>
</div>
<div class="d-flex align-items-center gap-2">
<span class="badge text-bg-light d-none" id="currentUserBadge"></span>
<button class="btn btn-sm btn-outline-secondary d-none" id="btnLogout">Sair</button>
</div>
</div>
</nav>
<main class="container py-4">
<!-- LOGIN / CADASTRO -->
<section class="row justify-content-center" id="authSection">
<div class="col-lg-5">
<div class="card p-4">
<h5 class="mb-3">Entrar</h5>
<div class="mb-2">
<label class="form-label">E-mail</label>
<input class="form-control" id="loginEmail" placeholder="voce@vale.com" type="email"/>
</div>
<div class="mb-3">
<label class="form-label">Senha</label>
<input class="form-control" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password"/>
</div>
<div class="d-grid gap-2">
<button class="btn btn-success" id="btnLogin" style="background: var(--vale-green); border-color: var(--vale-green);">Entrar</button>
<button class="btn btn-outline-secondary" id="btnShowSignup">Criar conta</button>
</div>
<!-- Informa√ß√£o do administrador oculta na tela de login. Para reexibir, remova display:none. --><div aria-hidden="true" class="alert alert-info mt-3" style="display:none;">
<div class="fw-semibold">Acesso do Administrador</div>
<div>Admin: <code>rafael.souza10@vale.com</code> (senha inicial <code>Vale@2025</code>)</div>
</div>
</div>
</div>
<div class="col-lg-5 d-none" id="signupCard">
<div class="card p-4">
<h5 class="mb-3">Criar conta</h5>
<div class="mb-2">
<label class="form-label">Nome</label>
<input class="form-control" id="suName" placeholder="Seu nome"/>
</div>
<div class="mb-2">
<label class="form-label">E-mail</label>
<input class="form-control" id="suEmail" placeholder="usuario@vale.com" type="email"/>
</div>
<div class="mb-2">
<label class="form-label">Senha</label>
<input class="form-control" id="suPassword" type="password"/>
</div>
<div class="d-grid mt-3">
<button class="btn btn-primary" id="btnSignup" style="background: var(--vale-teal); border-color: var(--vale-teal);">Registrar</button>
</div>
</div>
</div>
</section>
<!-- APP -->
<section class="d-none" id="appSection">
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
<li class="nav-item" role="presentation"><button class="nav-link active" data-bs-target="#tabFerramentas" data-bs-toggle="tab" role="tab" type="button">Ferramentas</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabScanner" data-bs-toggle="tab" role="tab" type="button">Scanner QR</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabEmprestimos" data-bs-toggle="tab" role="tab" type="button">Empr√©stimos</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabAdmin" data-bs-toggle="tab" role="tab" type="button">Administra√ß√£o</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabLog" data-bs-toggle="tab" role="tab" type="button">Log</button></li>
</ul>
<div class="tab-content py-3">
<!-- FERRAMENTAS -->
<div class="tab-pane fade show active" id="tabFerramentas" role="tabpanel">
<div class="d-flex flex-wrap gap-2 mb-3 align-items-end">
<div class="flex-grow-1">
<label class="form-label">Buscar</label>
<input class="form-control" id="searchTools" placeholder="Nome, c√≥digo ou status"/>
</div>
<div>
<label class="form-label">Status</label>
<select class="form-select" id="filterStatus">
<option value="all">Todos</option>
<option value="available">Dispon√≠vel</option>
<option value="loaned">Emprestada</option>
</select>
</div>
<button class="btn btn-success" data-bs-target="#modalTool" data-bs-toggle="modal" id="btnNewTool" style="background: var(--vale-green); border-color: var(--vale-green);">+ Nova ferramenta</button>
<button class="btn btn-outline-secondary" id="btnExport">Exportar JSON</button>
<label class="btn btn-outline-secondary mb-0">Importar JSON <input accept="application/json" class="d-none" id="importJson" type="file"/></label>
</div>
<div class="row g-3" id="toolsList"></div>
</div>
<!-- SCANNER -->
<div class="tab-pane fade" id="tabScanner" role="tabpanel">
<div class="row g-3">
<div class="col-lg-6">
<div class="card p-3">
<h6 class="mb-2">Ler QR code</h6>
<div class="border rounded" id="reader" style="min-height:320px;"></div>
<div class="form-text mt-2">Conceda acesso √† c√¢mera. Em desktop, prefira <b>localhost</b> ou <b>https</b>.</div>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h6 class="mb-2">Resultado</h6>
<div class="text-muted" id="scanResult">Aguardando leitura‚Ä¶</div>
</div>
</div>
</div>
</div>
<!-- EMPR√âSTIMOS -->
<div class="tab-pane fade" id="tabEmprestimos" role="tabpanel">
<div class="d-flex justify-content-between align-items-center mb-2">
<h6 class="mb-0">Ativos</h6>
<div class="form-text">Devolu√ß√£o em at√© <b>48h</b></div>
</div>
<div class="list-group" id="loansList"></div>
</div>
<!-- ADMIN -->
<div class="tab-pane fade" id="tabAdmin" role="tabpanel">
<div class="row g-3">
<div class="col-lg-6">
<div class="card p-3">
<h6>Configura√ß√µes de Marca</h6>
<div class="mb-2"><label class="form-label">URL do logo (SharePoint/Assets)</label><input class="form-control" id="cfgLogo" placeholder="https://.../vale-logo.svg"/>
  <label class="btn btn-outline-secondary mb-0" id="btnChooseLogo" style="display:inline-flex;align-items:center;gap:.5rem;margin-left:.5rem;cursor:pointer;">Escolher arquivo<input type="file" accept="image/*" id="cfgLogoFile" style="display:none;"></label>
  <div class="mt-2 d-flex align-items-center gap-2"><img id="cfgLogoPreview" alt="preview" style="height:40px; display:none; border-radius:6px; background:#fff; padding:4px;"/><small class="text-muted" id="cfgLogoInfo">Cole uma URL ou selecione um arquivo (max ~2MB).</small></div></div>
<div class="row g-2">
<div class="col-md-6"><label class="form-label">T√≠tulo da marca</label><input class="form-control" id="cfgBrandTitle" placeholder="Vale"/></div>
<div class="col-md-6"><label class="form-label">Slogan/Tagline</label><input class="form-control" id="cfgTag" placeholder="Seguran√ßa e produtividade em primeiro lugar"/></div>
</div>
<div class="row g-2 mt-1">
<div class="col-md-4"><label class="form-label">Prim√°ria</label><input class="form-control form-control-color" id="cfgPrimary" type="color" value="#1E6E43"/></div>
<div class="col-md-4"><label class="form-label">Secund√°ria</label><input class="form-control form-control-color" id="cfgSecondary" type="color" value="#3BA99C"/></div>
<div class="col-md-4"><label class="form-label">Fundo</label><input class="form-control form-control-color" id="cfgBg" type="color" value="#F4F6F6"/></div>
</div>
<div class="mb-2 mt-2"><label class="form-label">Webhook de e-mail (Power Automate)</label><input class="form-control" id="cfgWebhook" placeholder="https://prod-...logic.azure.com/..."/></div>
<div class="d-flex gap-2"><button class="btn btn-primary" id="btnSaveSettings" style="background: var(--vale-teal); border-color: var(--vale-teal);">Salvar</button><button class="btn btn-outline-secondary" id="btnResetBrand">Restaurar padr√£o</button></div>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h6>Usu√°rios (somente admin)</h6>
<div class="d-flex gap-2 mb-2">
<button class="btn btn-sm btn-success" id="btnNewUser" style="background: var(--vale-green); border-color: var(--vale-green);">+ Novo usu√°rio</button>
</div>
<div class="list-group small" id="usersList"></div>
</div>
</div>
<div class="col-12">
<div class="card p-3">
<h6>Imprimir QR Codes</h6>
<div id="qrArea"></div>
<div class="d-flex gap-2 mt-2"><button class="btn btn-outline-primary" id="btnRenderQRCodes">Gerar etiquetas</button><button class="btn btn-outline-secondary" onclick="window.print()">Imprimir</button></div>
</div>
</div>
</div>
</div>
<!-- LOG -->
<div class="tab-pane fade" id="tabLog" role="tabpanel"><div class="list-group small" id="logList"></div></div>
</div>
</section>
</main>
<footer class="vale-footer border-top py-3">
<div class="container d-flex flex-wrap justify-content-between align-items-center gap-2">
<div>¬© <span id="year"></span> Vale ‚Äî Uso interno</div>
<div class="d-flex gap-3"><a href="#" id="linkPoliticas" rel="noopener" target="_blank">Pol√≠ticas</a><a href="#" id="linkAjuda" rel="noopener" target="_blank">Ajuda</a></div>
</div>
</footer>
<!-- MODAL FERRAMENTA -->
<div class="modal fade" id="modalTool" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title" id="toolModalTitle">Nova ferramenta</h5><button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body">
<div class="row g-3">
<div class="col-md-6"><label class="form-label">Nome</label><input class="form-control" id="toolName" placeholder="Ex.: Chave de boca 24mm"/></div>
<div class="col-md-6"><label class="form-label">C√≥digo / QR</label>
<div class="input-group">
<input class="form-control" id="toolCode" placeholder="Ex.: FERR-0001"/>
<button class="btn btn-outline-secondary" id="btnScanFillCode" title="Ler QR para preencher" type="button"><span class="bi bi-qr-code"></span>Ler QR</button>
</div>
<div class="form-text">Use o scanner para preencher automaticamente.</div>
</div>
<div class="col-md-6"><label class="form-label">Foto</label><input accept="image/*" class="form-control" id="toolPhoto" type="file"/><img class="mt-2 tool-photo d-none" id="toolPreview"/></div>
<div class="col-md-6"><label class="form-label">Observa√ß√µes</label><input class="form-control" id="toolNotes" placeholder="Marca, estado, etc."/></div>
</div>
</div>
<div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">Cancelar</button><button class="btn btn-success" id="btnSaveTool" style="background: var(--vale-green); border-color: var(--vale-green);" type="button">Salvar</button></div>
</div></div>
</div>
<!-- MODAL NOVO USU√ÅRIO -->
<div class="modal fade" id="modalUser" tabindex="-1">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Novo usu√°rio</h5><button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body">
<div class="mb-2"><label class="form-label">Nome</label><input class="form-control" id="usrName" placeholder="Nome completo"/></div>
<div class="mb-2"><label class="form-label">E-mail</label><input class="form-control" id="usrEmail" placeholder="usuario@vale.com" type="email"/></div>
<div class="mb-2"><label class="form-label">Senha inicial</label><input class="form-control" id="usrPass" type="text" value="Vale@2025"/><div class="form-text">O usu√°rio pode alterar depois (no futuro SSO isso some).</div></div>
</div>
<div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-primary" id="btnSaveUser" style="background: var(--vale-teal); border-color: var(--vale-teal);">Salvar</button></div>
</div></div>
</div>
<!-- MODAL SCAN POR FERRAMENTA -->
<div class="modal fade" id="modalScanTool" tabindex="-1">
<div class="modal-dialog modal-md"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Escanear QR da ferramenta</h5><button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body">
<div class="small text-muted">Aponte a c√¢mera para o QR da ferramenta <b><span id="scanToolName"></span></b> (<code id="scanToolCode"></code>).</div>
<div class="border rounded mt-2" id="toolScanReader" style="min-height:280px;"></div>
<div class="mt-2 small" id="toolScanMsg"></div>
</div>
</div></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Modal de confirma√ß√£o de empr√©stimo -->
<div class="modal fade" id="confirmLoanModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Empr√©stimo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirmLoanText">Deseja realmente emprestar esta ferramenta?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmLoanBtn" style="background: var(--vale-green); border-color: var(--vale-green);">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    const ADMIN_EMAIL = 'rafael.souza10@vale.com';
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const ls = { get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d;}catch{return d;}}, set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const nowIso = () => new Date().toISOString();
    const fmt = (iso) => new Date(iso).toLocaleString();

    const DB = {
      users: () => ls.get('fi_users', []), tools: () => ls.get('fi_tools', []), loans: () => ls.get('fi_loans', []), logs: () => ls.get('fi_logs', []), settings: () => ls.get('fi_settings', { webhook:"" }), brand: () => ls.get('fi_brand', { logo:'', title:'Vale', tag:'Seguran√ßa e produtividade em primeiro lugar', links:{ politicas:'#', ajuda:'#' }, colors:{ primary:'#1E6E43', secondary:'#3BA99C', bg:'#F4F6F6' } })
    };
    function log(event, data={}){ const logs=DB.logs(); logs.unshift({id:uid(), ts:nowIso(), user:session.user?.email||'-', event, data}); ls.set('fi_logs', logs.slice(0,500)); renderLog(); }

    // Session
    const session = { user:null };
    const isAdmin = (u) => u && u.email && u.email.toLowerCase()===ADMIN_EMAIL.toLowerCase();
    function setSessionUser(user){ session.user = user ? {...user, role: isAdmin(user)?'admin':'user'} : null; if(user){ $('#currentUserBadge').textContent = `${session.user.name} (${session.user.role})`; $('#currentUserBadge').classList.remove('d-none'); $('#btnLogout').classList.remove('d-none'); $('#authSection').classList.add('d-none'); $('#appSection').classList.remove('d-none'); applyAdminGuards(); renderAll(); startScanner(); } else { $('#currentUserBadge').classList.add('d-none'); $('#btnLogout').classList.add('d-none'); $('#authSection').classList.remove('d-none'); $('#appSection').classList.add('d-none'); stopScanner(); } }
    function applyAdminGuards(){ const admin=isAdmin(session.user); $('#btnNewTool').style.display = admin? 'inline-block' : 'none'; $('#btnNewUser').disabled = !admin; $('#btnSaveTool').disabled = !admin;
      // üîí Oculta abas Administra√ß√£o e Log para n√£o-admins
      const adminTab = document.querySelector('button[data-bs-target="#tabAdmin"]');
      const logTab = document.querySelector('button[data-bs-target="#tabLog"]');
      if (adminTab && logTab) {
        if (!admin) {
          adminTab.parentElement.style.display = 'none';
          logTab.parentElement.style.display = 'none';
        } else {
          adminTab.parentElement.style.display = 'block';
          logTab.parentElement.style.display = 'block';
        }
      }
    }

    // Seed admin
    (function seed(){ const users=DB.users(); if(!users.find(u=>u.email && u.email.toLowerCase()===ADMIN_EMAIL.toLowerCase())){ users.push({ id:uid(), name:'Administrador', email:ADMIN_EMAIL, password:'Vale@2025', role:'admin', createdAt: nowIso() }); ls.set('fi_users', users); } })();

    // Auth
    $('#btnShowSignup').addEventListener('click', ()=> $('#signupCard').classList.toggle('d-none'));
    $('#btnSignup').addEventListener('click', ()=>{ const name=$('#suName').value.trim(); const email=($('#suEmail').value||'').trim().toLowerCase(); const pass=$('#suPassword').value; if(!name||!email||!pass) return alert('Preencha todos os campos'); if(email===ADMIN_EMAIL.toLowerCase()) return alert('A conta do administrador j√° existe e n√£o pode ser criada aqui.'); const users=DB.users(); if(users.find(u=>u.email && u.email.toLowerCase()===email)) return alert('E-mail j√° cadastrado'); users.push({ id:uid(), name, email, password:pass, role:'user', createdAt:nowIso() }); ls.set('fi_users', users); log('usuario_cadastrado_publico',{email}); alert('Cadastro realizado. Voc√™ j√° pode entrar.'); $('#signupCard').classList.add('d-none'); });
    $('#btnLogin').addEventListener('click', ()=>{ const email=($('#loginEmail').value||'').trim().toLowerCase(); const pass=$('#loginPassword').value; const user=DB.users().find(u=>u.email && u.email.toLowerCase()===email && u.password===pass); if(!user) return alert('Credenciais inv√°lidas'); setSessionUser(user); log('login',{email}); });
    $('#btnLogout').addEventListener('click', ()=> setSessionUser(null));

    // Users (admin)
    function renderUsers(){ const list=$('#usersList'); if(!list) return; list.innerHTML=''; const users=DB.users().sort((a,b)=> a.email.localeCompare(b.email)); users.forEach(u=>{ const admin=isAdmin(u); const li=document.createElement('div'); li.className='list-group-item'; li.innerHTML = `<div class="d-flex justify-content-between align-items-center"><div><div class="fw-semibold">${u.name||'-'} ${admin?'<span class="badge bg-success ms-2">admin</span>':''}</div><div class="text-muted">${u.email}</div></div><div class="d-flex gap-2"><button class="btn btn-sm btn-outline-secondary" data-action="reset" data-id="${u.id}" ${admin?'disabled':''}>Resetar senha</button><button class="btn btn-sm btn-outline-danger" data-action="del" data-id="${u.id}" ${admin?'disabled':''}>Excluir</button></div></div>`; list.appendChild(li); }); }
    $('#usersList').addEventListener('click', (e)=>{ const btn=e.target.closest('button'); if(!btn) return; if(!isAdmin(session.user)) return alert('Apenas o administrador pode gerenciar usu√°rios'); const id=btn.getAttribute('data-id'); const users=DB.users(); const u=users.find(x=>x.id===id); if(!u) return; const action=btn.getAttribute('data-action'); if(action==='reset'){ const nova=prompt('Nova senha para '+u.email+':','Vale@2025'); if(!nova) return; u.password=nova; ls.set('fi_users', users); log('usuario_reset_senha',{email:u.email}); alert('Senha redefinida.'); } else if(action==='del'){ if(isAdmin(u)) return alert('N√£o √© poss√≠vel excluir o administrador principal.'); if(confirm('Excluir usu√°rio '+u.email+'?')){ ls.set('fi_users', users.filter(x=>x.id!==u.id)); log('usuario_excluido',{email:u.email}); renderUsers(); } } });
    $('#btnNewUser').addEventListener('click', ()=>{ if(!isAdmin(session.user)) return alert('Apenas o administrador pode criar usu√°rios'); const modal=bootstrap.Modal.getOrCreateInstance('#modalUser'); $('#usrName').value=''; $('#usrEmail').value=''; $('#usrPass').value='Vale@2025'; modal.show(); });
    $('#btnSaveUser').addEventListener('click', ()=>{ if(!isAdmin(session.user)) return alert('Apenas o administrador pode criar usu√°rios'); const name=$('#usrName').value.trim(); const email=($('#usrEmail').value||'').trim().toLowerCase(); const pass=$('#usrPass').value.trim(); if(!name||!email||!pass) return alert('Preencha nome, e-mail e senha'); if(email===ADMIN_EMAIL.toLowerCase()) return alert('O e-mail do administrador j√° est√° cadastrado.'); const users=DB.users(); if(users.find(u=>u.email && u.email.toLowerCase()===email)) return alert('E-mail j√° cadastrado'); users.push({ id:uid(), name, email, password:pass, role:'user', createdAt:nowIso() }); ls.set('fi_users', users); log('usuario_criado_admin',{email}); bootstrap.Modal.getOrCreateInstance('#modalUser').hide(); renderUsers(); });

    // Tools
    let editToolId=null;
    function openToolModal(tool){ if(!isAdmin(session.user)) return alert('Apenas o administrador pode adicionar/editar ferramentas'); editToolId = tool? tool.id : null; $('#toolModalTitle').textContent = tool? 'Editar ferramenta' : 'Nova ferramenta'; $('#toolName').value = tool?.name || ''; $('#toolCode').value = tool?.code || ''; $('#toolNotes').value = tool?.notes || ''; const prev=$('#toolPreview'); if(tool?.photo){ prev.src=tool.photo; prev.classList.remove('d-none'); } else { prev.classList.add('d-none'); } }
    $('#toolPhoto').addEventListener('change', (e)=>{ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ $('#toolPreview').src=reader.result; $('#toolPreview').classList.remove('d-none'); }; reader.readAsDataURL(file); });

    // Fill code by scanning (from Tool modal)
    let fillCodeScanner=null;
    $('#btnScanFillCode').addEventListener('click', ()=>{
      if(!isAdmin(session.user)) return alert('Apenas o administrador pode usar esta fun√ß√£o');
      try{
        if(fillCodeScanner){ fillCodeScanner.stop().catch(()=>{}); fillCodeScanner.clear().catch(()=>{}); fillCodeScanner=null; }
        const tempId='toolScanTemp';
        const tempBox=document.createElement('div'); tempBox.id=tempId; tempBox.className='border rounded mt-2'; tempBox.style.minHeight='220px';
        $('#toolCode').closest('.col-md-6').appendChild(tempBox);
        fillCodeScanner=new Html5Qrcode(tempId);
        fillCodeScanner.start({ facingMode:'environment' }, { fps:10, qrbox:200 }, (text)=>{ $('#toolCode').value=text; }, (err)=>{});
      }catch(e){ alert('N√£o foi poss√≠vel iniciar a c√¢mera. Use o Scanner QR na aba principal.'); }
    });

    $('#btnSaveTool').addEventListener('click', ()=>{ if(!isAdmin(session.user)) return alert('Apenas o administrador pode adicionar/editar ferramentas'); const name=$('#toolName').value.trim(); const code=$('#toolCode').value.trim(); const notes=$('#toolNotes').value.trim(); const photo=$('#toolPreview').getAttribute('src')||''; if(!name||!code) return alert('Informe nome e c√≥digo'); const tools=DB.tools(); if(editToolId){ const t=tools.find(x=>x.id===editToolId); t.name=name; t.code=code; t.notes=notes; if(photo) t.photo=photo; log('ferramenta_editada',{id:t.id,code}); } else { if(tools.some(t=>t.code===code)) return alert('C√≥digo j√° existente'); tools.push({ id:uid(), name, code, notes, photo, status:'available', holder:null, createdAt: nowIso(), updatedAt: nowIso() }); log('ferramenta_criada',{code}); } ls.set('fi_tools', tools); $('#toolName').value=''; $('#toolCode').value=''; $('#toolNotes').value=''; $('#toolPreview').classList.add('d-none'); bootstrap.Modal.getOrCreateInstance('#modalTool').hide(); if(fillCodeScanner){ fillCodeScanner.stop().catch(()=>{}); fillCodeScanner.clear().catch(()=>{}); fillCodeScanner=null; } renderTools(); renderQR(); });


function renderTools(){ const term=$('#searchTools').value?.trim().toLowerCase()||''; const fStatus=$('#filterStatus').value; const tools=DB.tools().filter(t=>{ const hay=`${t.name} ${t.code} ${t.status}`.toLowerCase(); const okTerm=!term||hay.includes(term); const okStatus=fStatus==='all'||t.status===fStatus; return okTerm && okStatus; }); const container=$('#toolsList'); container.innerHTML=''; if(!tools.length){ container.innerHTML='<div class="text-muted">Nenhuma ferramenta.</div>'; return; } tools.forEach(t=>{ const col=document.createElement('div'); col.className='col-md-6 col-lg-4'; const admin=isAdmin(session.user); const isHolder = session.user && t.holder === session.user.id; const holderUser = t.holder ? DB.users().find(u=>u.id===t.holder) : null; const holderName = holderUser ? holderUser.name : null; let returnBtnText = t.status==='available' ? 'Emprestar' : 'Devolver'; let returnBtnDisabled = t.status==='loaned' && !isHolder; let returnBtnStyle = t.status==='available' ? 'border-color: var(--vale-green); color: var(--vale-green);' : (isHolder ? '' : 'opacity:0.6;'); const holderClass = isHolder ? 'border-3 border-primary' : ''; col.innerHTML=`      <div class="card p-3 h-100" style="border-top:4px solid var(--vale-teal);">\n        <div class="d-flex align-items-center gap-3">\n          <img src="${t.photo||'https://via.placeholder.com/64?text=%F0%9F%9B%A0%EF%B8%8F'}" class="tool-photo" alt="foto" />\n          <div class="flex-grow-1">\n            <div class="d-flex justify-content-between align-items-start">\n              <div>\n                <div class="fw-semibold">${t.name}</div>\n                <div class="text-muted small">${t.code}</div>\n              </div>\n              <span class="badge ${t.status==='available' ? 'bg-success' : 'bg-warning text-dark'} status-badge">${t.status==='available'?'Dispon√≠vel':'Emprestada'}</span>\n            </div>\n            <div class="small text-muted">${t.notes||''}</div>\n            ${t.status==='loaned' && holderName ? `<div class="small mt-2">Emprestado para: <strong>${holderName}</strong>${isHolder? ' <span class="badge bg-warning text-dark ms-2">Voc√™</span>' : ''}</div>` : ''}\n          </div>\n        </div>\n        <div class="d-flex flex-wrap gap-2 mt-3">\n          <button class="btn btn-sm btn-outline-primary" data-action="loan" data-id="${t.id}" style="${returnBtnStyle}" ${returnBtnDisabled? 'disabled' : ''}>${returnBtnText}</button>\n          <button class="btn btn-sm btn-outline-success" data-action="scan" data-id="${t.id}">Escanear QR</button>\n          <button class="btn btn-sm btn-outline-secondary" data-action="edit" data-id="${t.id}" data-bs-toggle="modal" data-bs-target="#modalTool" ${!admin?'disabled':''}>Editar</button>\n          <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${t.id}" ${!admin?'disabled':''}>Excluir</button>\n        </div>\n      </div>`; container.appendChild(col); }); }
    $('#toolsList').addEventListener('click', (e)=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action'); const tools=DB.tools(); const t=tools.find(x=>x.id===id); if(!t) return; if(action==='edit') return openToolModal(t); if(action==='delete'){ if(!isAdmin(session.user)) return alert('Apenas o administrador pode excluir ferramentas'); if(confirm('Excluir esta ferramenta?')){ const loans=DB.loans(); if(loans.some(l=>l.toolId===id && l.returnedAt==null)) return alert('N√£o √© poss√≠vel excluir: ferramenta emprestada.'); ls.set('fi_tools', tools.filter(x=>x.id!==id)); log('ferramenta_excluida',{code:t.code}); renderTools(); renderQR(); } } if(action==='loan'){ if(t.status==='available') doLoan(t); else { if(!session.user || t.holder !== session.user.id){ return alert('Apenas o usu√°rio que realizou o empr√©stimo pode devolver esta ferramenta.'); } showReturnModal(t, ({condition,note}={})=>{ doReturn(t); }); } } if(action==='scan'){ openScanToolModal(t); } });

    $('#searchTools').addEventListener('input', renderTools); $('#filterStatus').addEventListener('change', renderTools);

    // Loans
    function doLoan(tool){ if(!session.user) return alert('Fa√ßa login.'); const tools=DB.tools(); const t=tools.find(x=>x.id===tool.id); if(t.status!=='available') return alert('J√° emprestada.'); const loans=DB.loans(); const dueAt=new Date(Date.now()+48*60*60*1000).toISOString(); loans.unshift({ id:uid(), toolId:t.id, toolCode:t.code, toolName:t.name, userId:session.user.id, userEmail:session.user.email, userName:session.user.name, loanedAt:nowIso(), dueAt, returnedAt:null }); ls.set('fi_loans', loans); t.status='loaned'; t.holder=session.user.id; t.updatedAt=nowIso(); ls.set('fi_tools', tools); log('emprestimo_criado',{tool:t.code, para:session.user.email, dueAt}); renderLoans(); renderTools(); triggerWebhook('loan_created', { tool: pick(t,['id','code','name']), user: pick(session.user,['id','name','email']), dueAt, reminderHours:48 }); }
    function doReturn(tool){ const tools=DB.tools(); const t=tools.find(x=>x.id===tool.id); const loans=DB.loans(); const l=loans.find(x=>x.toolId===t.id && x.returnedAt==null); if(!l) return alert('Empr√©stimo n√£o encontrado.'); l.returnedAt=nowIso(); ls.set('fi_loans', loans); t.status='available'; t.holder=null; t.updatedAt=nowIso(); ls.set('fi_tools', tools); log('emprestimo_devolvido',{tool:t.code}); renderLoans(); renderTools(); triggerWebhook('loan_returned', { loanId:l.id, tool: pick(t,['id','code','name']), user: pick(session.user,['id','name','email']) }); }
    function renderLoans(){ const loans=DB.loans().filter(l=>!l.returnedAt); const box=$('#loansList'); box.innerHTML=''; if(!loans.length){ box.innerHTML='<div class="list-group-item">Sem empr√©stimos ativos.</div>'; return; } loans.forEach(l=>{ const overdue=new Date(l.dueAt) < new Date(); const isMine = session.user && session.user.id === l.userId; const item=document.createElement('div'); item.className='list-group-item'; item.innerHTML = `<div class="d-flex justify-content-between align-items-center"><div><div class="fw-semibold">${l.toolName} <span class="text-muted small">(${l.toolCode})</span></div><div class="small text-muted">Para: <strong>${l.userName}</strong> ${isMine?'<span class="badge bg-warning text-dark ms-2">Voc√™</span>':''} <div class="small text-muted">&lt;${l.userEmail}&gt;</div></div></div><div class="text-end"><div class="badge ${overdue?'bg-danger':'bg-secondary'}">${overdue?'Atrasado':'At√©'} ${fmt(l.dueAt)}</div></div></div>`; box.appendChild(item); }); }
    setInterval(()=>{ renderLoans(); }, 60*1000);

    // Log
    function renderLog(){ const logs=DB.logs(); const box=$('#logList'); box.innerHTML=''; logs.forEach(x=>{ const item=document.createElement('div'); item.className='list-group-item'; item.innerHTML=`<div class=\"d-flex justify-content-between\"><div><b>${x.event}</b> ‚Äî ${JSON.stringify(x.data)}</div><div class=\"text-muted\">${fmt(x.ts)}</div></div>`; box.appendChild(item); }); }

    // Global Scanner (tab)
    let html5QrcodeScanner=null;
    function startScanner(){ const el=$('#reader'); if(!el) return; stopScanner(); try{ html5QrcodeScanner=new Html5Qrcode('reader'); Html5Qrcode.getCameras().then(cams=>{ html5QrcodeScanner.start({ facingMode:'environment' }, { fps:10, qrbox:250 }, onScanSuccess, (err)=>{}); }).catch(()=>{ html5QrcodeScanner.start({ facingMode:'environment' }, { fps:10, qrbox:250 }, onScanSuccess, (err)=>{}); }); }catch(e){ console.warn('Scanner error', e); } }
    function stopScanner(){ if(html5QrcodeScanner){ html5QrcodeScanner.stop().catch(()=>{}); html5QrcodeScanner.clear().catch(()=>{}); html5QrcodeScanner=null; } }
    function onScanSuccess(decodedText){
      $('#scanResult').textContent=decodedText;
      const toolModal=document.getElementById('modalTool');
      const isOpen=toolModal.classList.contains('show');
      if(isOpen){ $('#toolCode').value=decodedText; return; }
      const tools=DB.tools();
      const t=tools.find(x=>x.code===decodedText);
      if(!t){ $('#scanResult').innerHTML=`C√≥digo <b>${decodedText}</b> n√£o cadastrado.`; return; }
      // Se dispon√≠vel, pedir confirma√ß√£o antes do empr√©stimo
      if(t.status==='available'){
        if(!session.user) return alert('Fa√ßa login.');
        showConfirmLoan(t, ()=>{
          doLoan(t);
          $('#scanResult').innerHTML = `Emprestado: <b>${t.name}</b> (${t.code}) para ${session.user?.name||'?'}.`;
        });
      } else {
        if(!session.user || t.holder !== session.user.id){ $('#scanResult').innerHTML = `Ferramenta emprestada para <b>${DB.users().find(u=>u.id===t.holder)?.name||'outro usu√°rio'}</b>. Apenas ele pode devolver.`; return; }
        showReturnModal(t, ({condition,note}={})=>{ doReturn(t); });
        $('#scanResult').innerHTML = `Devolvido: <b>${t.name}</b> (${t.code}).`;
      }
    }

    // Per-tool scanner (modal)
    let toolScanner=null, toolScanningId=null;
    async function openScanToolModal(tool){
  // Garante que nenhum scanner anterior esteja rodando (evita erro de c√¢mera em tablets)
  if (window.stopScanner) await window.stopScanner();
  if (window.stopToolScanner) await window.stopToolScanner();

  toolScanningId = tool.id;
  $('#scanToolName').textContent = tool.name;
  $('#scanToolCode').textContent = tool.code;
  $('#toolScanMsg').textContent = '';

  const modal = bootstrap.Modal.getOrCreateInstance('#modalScanTool');
  modal.show();

  // Pequeno delay antes de iniciar a c√¢mera (necess√°rio em alguns tablets)
  setTimeout(() => {
    if (window.startToolScanner) window.startToolScanner();
    else startToolScanner();
  }, 400);
}
    function stopToolScanner(){ if(toolScanner){ toolScanner.stop().catch(()=>{}); toolScanner.clear().catch(()=>{}); toolScanner=null; } }
    function onToolScanSuccess(decodedText){ const tools=DB.tools(); const t=tools.find(x=>x.id===toolScanningId); if(!t) return; if(decodedText===t.code){ $('#toolScanMsg').innerHTML = '<span class=\"text-success\">QR correspondente! Processando‚Ä¶</span>'; if(t.status==='available'){ if(!session.user){ $('#toolScanMsg').innerHTML = '<span class=\"text-danger\">Fa√ßa login para emprestar.</span>'; return; } showConfirmLoan(t, ()=>{ doLoan(t); setTimeout(()=>{ bootstrap.Modal.getOrCreateInstance('#modalScanTool').hide(); }, 600); }); } else { showReturnModal(t, ({condition,note}={})=>{ doReturn(t); }); setTimeout(()=>{ bootstrap.Modal.getOrCreateInstance('#modalScanTool').hide(); }, 600); } } else { $('#toolScanMsg').innerHTML = `<span class="text-danger">QR lido n√£o corresponde. Esperado <code>${t.code}</code>, lido <code>${decodedText}</code>.</span>`; } }
    document.getElementById('modalScanTool').addEventListener('hidden.bs.modal', stopToolScanner);

    // Export/Import, QR print, Settings
    function pick(obj, keys){ const o={}; keys.forEach(k=>o[k]=obj[k]); return o; }
    function triggerWebhook(event, payload){ const url=DB.settings().webhook; if(!url) return; fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ event, at: nowIso(), ...payload }) }) .then(()=>log('webhook_ok',{event})).catch(()=>log('webhook_erro',{event})); }
    $('#btnExport').addEventListener('click', ()=>{ const data={ users:DB.users(), tools:DB.tools(), loans:DB.loans(), logs:DB.logs(), settings:DB.settings(), brand:DB.brand() }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ferramentaria_vale_full_${new Date().toISOString().slice(0,19)}.json`; a.click(); URL.revokeObjectURL(url); });
    $('#importJson').addEventListener('change', (e)=>{ const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.users){ const keepAdmin = DB.users().find(u=>u.email && u.email.toLowerCase()===ADMIN_EMAIL.toLowerCase()); let importedUsers = obj.users; if(!importedUsers.find(u=>u.email && u.email.toLowerCase()===ADMIN_EMAIL.toLowerCase())){ importedUsers.push(keepAdmin || { id:uid(), name:'Administrador', email:ADMIN_EMAIL, password:'Vale@2025', role:'admin', createdAt:nowIso() }); } ls.set('fi_users', importedUsers); } if(obj.tools) ls.set('fi_tools', obj.tools); if(obj.loans) ls.set('fi_loans', obj.loans); if(obj.logs)  ls.set('fi_logs',  obj.logs); if(obj.settings) ls.set('fi_settings', obj.settings); if(obj.brand) ls.set('fi_brand', obj.brand); alert('Importado com sucesso'); applyBrand(); renderAll(); }catch(err){ alert('JSON inv√°lido'); } }; r.readAsText(file); });
    function renderQR(){ const box=$('#qrArea'); if(!box) return; box.innerHTML=''; DB.tools().forEach(t=>{ const wrap=document.createElement('div'); wrap.className='qr-print'; wrap.innerHTML = `<div id="qr_${t.id}"></div><small>${t.name}</small><small>${t.code}</small>`; box.appendChild(wrap); const qrel=document.getElementById(`qr_${t.id}`); new QRCode(qrel,{ text:t.code, width:96, height:96 }); }); }
    $('#btnRenderQRCodes')?.addEventListener('click', renderQR);
    $('#btnSaveSettings').addEventListener('click', ()=>{ const s=DB.settings(); s.webhook=$('#cfgWebhook').value.trim(); ls.set('fi_settings', s); const b=DB.brand(); b.logo=$('#cfgLogo').value.trim(); b.title=$('#cfgBrandTitle').value.trim()||'Vale'; b.tag=$('#cfgTag').value.trim()||'Seguran√ßa e produtividade em primeiro lugar'; b.colors.primary=$('#cfgPrimary').value; b.colors.secondary=$('#cfgSecondary').value; b.colors.bg=$('#cfgBg').value; ls.set('fi_brand', b); applyBrand(); alert('Configura√ß√µes salvas'); });
    $('#btnResetBrand').addEventListener('click', ()=>{ ls.set('fi_brand', { logo:'', title:'Vale', tag:'Seguran√ßa e produtividade em primeiro lugar', links:{ politicas:'#', ajuda:'#' }, colors:{ primary:'#1E6E43', secondary:'#3BA99C', bg:'#F4F6F6' } }); applyBrand(); });
    function applyBrand(){ const b=DB.brand(); document.documentElement.style.setProperty('--vale-green', b.colors.primary); document.documentElement.style.setProperty('--vale-teal', b.colors.secondary); document.documentElement.style.setProperty('--vale-bg', b.colors.bg); $('#valeLogo').src = b.logo || 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 120 28\"><rect width=\"120\" height=\"28\" fill=\"white\"/><text x=\"8\" y=\"19\" font-family=\"Segoe UI, Arial\" font-size=\"14\" fill=\"#1E6E43\">Vale</text></svg>`); $('#brandTitle').textContent = b.title||'Vale'; $('#siteTag').textContent = b.tag||''; const links=b.links||{ politicas:'#', ajuda:'#' }; $('#linkPoliticas').href = links.politicas||'#'; $('#linkAjuda').href = links.ajuda||'#'; }

    function renderAll(){ renderTools(); renderLoans(); renderLog(); renderUsers(); $('#cfgWebhook').value = DB.settings().webhook || ''; preloadBrandToForm(); applyAdminGuards(); }
    function preloadBrandToForm(){ const b=DB.brand(); $('#cfgLogo').value=b.logo||''; $('#cfgBrandTitle').value=b.title||'Vale'; $('#cfgTag').value=b.tag||''; $('#cfgPrimary').value=b.colors?.primary||'#1E6E43'; $('#cfgSecondary').value=b.colors?.secondary||'#3BA99C'; $('#cfgBg').value=b.colors?.bg||'#F4F6F6'; }

    // Fun√ß√£o utilit√°ria para exibir modal de confirma√ß√£o de empr√©stimo
    function showConfirmLoan(tool, onConfirm){
      const modalEl = document.getElementById('confirmLoanModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      const text = document.getElementById('confirmLoanText');
      text.innerHTML = `Deseja emprestar <strong>${tool.name}</strong> (<code>${tool.code}</code>)?`;
      const confirmBtn = document.getElementById('confirmLoanBtn');
      // remover handlers anteriores
      confirmBtn.replaceWith(confirmBtn.cloneNode(true));
      const newBtn = document.getElementById('confirmLoanBtn');
      newBtn.addEventListener('click', ()=>{
        try{ onConfirm(); }catch(e){ console.error(e); }
        modal.hide();
      }, { once:true });
      modal.show();
    }

    document.addEventListener('DOMContentLoaded', ()=>{ applyBrand(); renderAll(); document.getElementById('year').textContent = new Date().getFullYear(); });
    document.getElementById('modalTool').addEventListener('hidden.bs.modal', ()=>{ if(fillCodeScanner){ fillCodeScanner.stop().catch(()=>{}); fillCodeScanner.clear().catch(()=>{}); fillCodeScanner=null; } });
  </script>

<!-- Idle grace modal with progress bar (injected) -->
<div class="modal fade" id="idleGraceModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Sess√£o quase expirada</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body text-center">
        <p>Ficou inativo. A sess√£o ser√° encerrada em <strong id="idleGraceRemaining">15s</strong>.</p>
        <div class="progress" style="height:10px; border-radius:8px; overflow:hidden;">
          <div id="idleGraceProgress" class="progress-bar" role="progressbar" style="width:100%" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="small text-muted mt-2">Clique em "Continuar sess√£o" para permanecer logado.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="idleGraceLogout">Encerrar agora</button>
        <button type="button" class="btn btn-success" id="idleGraceKeep">Continuar sess√£o</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const IDLE_MS = 60 * 1000; // 60s
  const GRACE_MS = 15 * 1000; // 15s
  let idleTimer = null, graceTimer = null, progressInterval = null;

  function clearTimers(){
    if(idleTimer){ clearTimeout(idleTimer); idleTimer = null; }
    if(graceTimer){ clearTimeout(graceTimer); graceTimer = null; }
    if(progressInterval){ clearInterval(progressInterval); progressInterval = null; }
  }

  function doLogout(){
    clearTimers();
    try{
      if(typeof setSessionUser === 'function'){
        setSessionUser(null);
      } else {
        // fallback
        location.reload();
      }
    }catch(e){
      console.warn('logout fallback', e);
      location.reload();
    }
  }

  function showGraceModal(){
    clearTimers();
    const modalEl = document.getElementById('idleGraceModal');
    if(!modalEl) return doLogout();
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    const bar = document.getElementById('idleGraceProgress');
    const remainingEl = document.getElementById('idleGraceRemaining');
    const keepBtn = document.getElementById('idleGraceKeep');
    const logoutBtn = document.getElementById('idleGraceLogout');
    let end = Date.now() + GRACE_MS;
    bar.style.width = '100%';
    remainingEl.textContent = Math.ceil(GRACE_MS/1000) + 's';

    // wire buttons
    keepBtn.onclick = function(){ modal.hide(); resetIdle(); };
    logoutBtn.onclick = function(){ modal.hide(); doLogout(); };

    modal.show();

    progressInterval = setInterval(()=>{
      const remaining = Math.max(0, end - Date.now());
      const pct = (remaining / GRACE_MS) * 100;
      bar.style.width = pct + '%';
      remainingEl.textContent = Math.ceil(remaining/1000) + 's';
      if(remaining <= 0){
        clearInterval(progressInterval);
        progressInterval = null;
        modal.hide();
        doLogout();
      }
    }, 100);

    // hard fail-safe
    graceTimer = setTimeout(()=>{ try{ modal.hide(); }catch(e){} doLogout(); }, GRACE_MS + 200);
  }

  function resetIdle(){
    clearTimers();
    idleTimer = setTimeout(()=>{ showGraceModal(); }, IDLE_MS);
  }

  ['click','mousemove','keydown','scroll','touchstart'].forEach(evt=>{
    window.addEventListener(evt, ()=>{ resetIdle(); }, {passive:true});
  });

  // start
  document.addEventListener('DOMContentLoaded', ()=>{ resetIdle(); });
})();
</script>


<!-- RETURN CONDITION MODAL - ADDED BY CHATGPT -->
<!-- Modal: returnConditionModal -->
<div class="modal fade" id="returnConditionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Devolu√ß√£o - Condi√ß√£o da ferramenta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      
    <!-- Foto de registro (adicionado) -->
    <div class="mb-3" id="returnPhotoSection" style="margin-top:10px;">
      <label for="returnPhotoInput" style="display:block; font-weight:600; margin-bottom:6px;">Registro fotogr√°fico (opcional)</label>
      <input type="file" id="returnPhotoInput" accept="image/*" capture="environment" style="display:block; margin-bottom:8px;" />
      <div id="returnPhotoPreview" style="display:none; margin-top:6px;">
        <img id="returnPhotoImg" src="" alt="Preview foto" style="max-width:180px; border-radius:6px; border:1px solid #ddd;" />
        <div><button type="button" id="clearReturnPhoto" style="margin-top:6px;">Remover foto</button></div>
      </div>
    </div>
    <!-- /Foto de registro --></div>
      <div class="modal-body">
        <div id="returnToolInfo" class="mb-2 small text-muted"></div>

        <div class="mb-3">
          <label class="form-label">Selecione a condi√ß√£o</label>
          <select id="returnConditionSelect" class="form-select">
            <option value="clean">Boas condi√ß√µes / Limpa</option>
            <option value="dirty">Suja</option>
            <option value="damaged">Danificada</option>
          </select>
        </div>

        <div id="returnDescWrapper" class="mb-3" style="display:none;">
          <label class="form-label">Descri√ß√£o (obrigat√≥ria)</label>
          <textarea id="returnDescription" class="form-control" rows="3" placeholder="Descreva o que aconteceu..."></textarea>
          <div class="form-text small text-muted">Campo obrigat√≥rio para aceitar devolu√ß√£o quando a ferramenta estiver suja ou danificada.</div>
        </div>

        <div id="returnPreviewNote" class="small text-muted"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmReturnBtn">Aceitar devolu√ß√£o</button>
      </div>
    </div>
  </div>
</div>
<!-- END RETURN CONDITION MODAL -->



<!-- RETURN CONDITION SCRIPT - ADDED BY CHATGPT -->
<script>
function showReturnModal(tool, onConfirm){
  const modalEl = document.getElementById('returnConditionModal');
  if(!modalEl){
    console.error('Modal de devolu√ß√£o n√£o encontrado.');
    if(typeof onConfirm === 'function') onConfirm({condition:'clean', note:''});
    return;
  }
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

  // query elements scoped to the modal element to avoid clashes
  const info = modalEl.querySelector('#returnToolInfo');
  const select = modalEl.querySelector('#returnConditionSelect');
  const descWrap = modalEl.querySelector('#returnDescWrapper');
  const desc = modalEl.querySelector('#returnDescription');
  const confirmBtn = modalEl.querySelector('#confirmReturnBtn');

  if(!info || !select || !descWrap || !desc || !confirmBtn){
    console.error('Algum elemento do modal de devolu√ß√£o est√° faltando.', {info, select, descWrap, desc, confirmBtn});
    if(typeof onConfirm === 'function') onConfirm({condition:'clean', note:''});
    return;
  }

  // initialize fields
  info.innerHTML = `<strong>${(tool && (tool.name || tool.title)) || 'Ferramenta'}</strong> <small class="text-muted">(${tool && tool.code || ''})</small>`;
  select.value = 'clean';
  desc.value = '';
  desc.setAttribute('maxlength','300');
  descWrap.style.display = 'none';

  // remove previously attached listeners safely using stored refs
  if(confirmBtn._listener) {
    confirmBtn.removeEventListener('click', confirmBtn._listener);
    delete confirmBtn._listener;
  }
  if(select._listener) {
    select.removeEventListener('change', select._listener);
    delete select._listener;
  }

  // handler for select change
  const selectListener = function(){
    const v = select.value;
    if(v === 'clean'){
      descWrap.style.display = 'none';
    } else {
      descWrap.style.display = 'block';
      setTimeout(()=> desc.focus(), 200);
    }
  };

  select.addEventListener('change', selectListener);
  select._listener = selectListener;

  // handler for confirm button
  const confirmListener = function(e){
    e.preventDefault();
    const cond = select.value;
    const text = desc.value.trim();
    if((cond === 'dirty' || cond === 'damaged') && !text){
      alert('Por favor, descreva o problema para aceitar a devolu√ß√£o.');
      desc.focus();
      return;
    }

    // try to attach note to loan record if DB.loans exists
    try{
      if(window.DB && typeof DB.loans === 'function'){
        const loans = DB.loans();
        const loan = loans && loans.find(l => l.toolId === tool.id && !l.returnedAt);
        if(loan){
          loan.returnCondition = cond;
          loan.returnNote = text || '';
          loan._pendingReturn = true;
          if(window.ls && typeof ls.set === 'function') ls.set('fi_loans', loans);
        }
      }
    }catch(err){
      console.warn('Erro ao anexar condi√ß√£o ao empr√©stimo', err);
    }

    modal.hide();
    try{ if(typeof onConfirm === 'function') onConfirm({ condition: cond, note: text }); }catch(err){ console.error(err); }
  };

  confirmBtn.addEventListener('click', confirmListener);
  confirmBtn._listener = confirmListener;

  // show modal
  modal.show();
}
</script>
<!-- END RETURN CONDITION SCRIPT -->




<!-- ADMIN RETURN ISSUES MODAL - ADDED BY CHATGPT -->
<div class="modal fade" id="adminReturnIssuesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Devolu√ß√µes - Sujas / Danificadas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="adminReturnIssuesContent">
          <p class="small text-muted" id="adminReturnIssuesCount">Carregando...</p>
          <div class="table-responsive">
            <table class="table table-sm" id="adminReturnIssuesTable">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Nome</th>
                  <th>Usu√°rio</th>
                  <th>Condi√ß√£o</th>
                  <th>Descri√ß√£o</th>
                  <th>Data Devolu√ß√£o</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="adminReturnIssuesRefresh" type="button" class="btn btn-outline-secondary">Atualizar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN BUTTON (hidden by default, shown to admins via JS) -->
<style>
#btnReturnIssues {
  position: fixed;
  right: 18px;
  bottom: 18px;
  z-index: 1055;
  display: none;
}
</style>
<button id="btnReturnIssues" class="btn btn-warning btn-sm">Devolu√ß√µes com problema</button>
<!-- END ADMIN RETURN ISSUES MODAL -->

<!-- ADMIN RETURN ISSUES SCRIPT - ADDED BY CHATGPT -->
<script>
function getReturnIssueLoans(){
  try{
    if(window.DB && typeof DB.loans === 'function'){
      const loans = DB.loans() || [];
      return loans.filter(l => l.returnCondition && (l.returnCondition === 'dirty' || l.returnCondition === 'damaged'));
    }
    return [];
  }catch(e){
    console.error('Erro ao obter loans para summary', e);
    return [];
  }
}

function renderAdminReturnIssues(){
  const rows = getReturnIssueLoans();
  const tableBody = document.querySelector('#adminReturnIssuesTable tbody');
  const countEl = document.getElementById('adminReturnIssuesCount');
  tableBody.innerHTML = '';
  if(!rows.length){
    countEl.textContent = 'Nenhuma devolu√ß√£o com problema encontrada.';
  } else {
    countEl.textContent = rows.length + ' devolu√ß√£o(√µes) com problema encontrada(s).';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      const userName = (window.DB && typeof DB.users === 'function' && DB.users().find(u=>u.id===r.userId)?.name) || (r.holderName || r.holder || '‚Äî');
      const returnedAt = r.returnedAt ? new Date(r.returnedAt).toLocaleString() : (r._pendingReturn ? 'Pendente' : '‚Äî');
      tr.innerHTML = `
        <td>${r.toolCode || (r.tool && r.tool.code) || '‚Äî'}</td>
        <td>${r.toolName || (r.tool && r.tool.name) || r.toolId || '‚Äî'}</td>
        <td>${userName}</td>
        <td>${r.returnCondition}</td>
        <td>${(r.returnNote||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</td>
        <td>${returnedAt}</td>
      `;
      tableBody.appendChild(tr);
    });
  }
}

// open modal (and refresh)
function showAdminReturnIssuesModal(){
  renderAdminReturnIssues();
  const modalEl = document.getElementById('adminReturnIssuesModal');
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
}

// Wire button and refresh
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('btnReturnIssues');
  if(btn){
    btn.addEventListener('click', showAdminReturnIssuesModal);
  }
  const refreshBtn = document.getElementById('adminReturnIssuesRefresh');
  if(refreshBtn){
    refreshBtn.addEventListener('click', renderAdminReturnIssues);
  }

  // Show admin button if session.user is admin (common pattern in your app)
  try{
    if(window.session && session.user && (session.user.isAdmin || session.user.role === 'admin' || session.user.type === 'admin')){
      const b = document.getElementById('btnReturnIssues');
      if(b) b.style.display = 'block';
    }
  }catch(e){}
});
</script>
<!-- END ADMIN RETURN ISSUES SCRIPT -->


<!-- Robust scanner management injected by assistant -->
<script>
// Robust scanner management (overrides previous implementations if any)
(async function(){
  // hold instances
  window._robustScanners = window._robustScanners || {};
  const S = window._robustScanners;

  S.html5QrcodeScanner = null;
  S.toolScanner = null;
  S.fillCodeScanner = null;

  async function safeStop(instance){
    try{
      if(!instance) return;
      if(typeof instance.stop === 'function'){
        await instance.stop().catch(()=>{});
      }
      if(typeof instance.clear === 'function'){
        try{ instance.clear(); }catch(e){}
      }
    }catch(e){
      console.warn('safeStop error', e);
    }
  }

  async function stopGlobalScanner(){
    try{
      await safeStop(S.html5QrcodeScanner);
    }catch(e){ console.warn(e); }
    S.html5QrcodeScanner = null;
    const reader = document.getElementById('reader');
    if(reader) reader.innerHTML = '';
  }

  
async function startGlobalScanner(){
  const el = document.getElementById('reader');
  if(!el) return;
  await stopGlobalScanner();
  try{
    S.html5QrcodeScanner = new Html5Qrcode('reader');

    // tenta listar c√¢meras
    let chosen = null;
    try{
      const cams = await Html5Qrcode.getCameras();
      if(cams && cams.length){
        // Prefer camera cujo label sugira "traseira"
        const prefer = cams.find(c => /back|rear|traseira|environment/i.test(c.label || ''));
        // se n√£o encontrou, tenta heur√≠stica: escolher a √∫ltima (muitos dispositivos colocam traseira por √∫ltimo)
        const fallback = cams[cams.length-1];
        chosen = prefer || fallback || cams[0];
        console.log('Available cameras (global):', cams, 'chosen:', chosen);
      }
    }catch(e){
      console.warn('getCameras failed (global)', e);
    }

    // Se temos um deviceId use-o, sen√£o tente facingMode exact, sen√£o fallback
    let cameraConfig = null;
    if(chosen && chosen.id) cameraConfig = chosen.id;
    else cameraConfig = { facingMode: { exact: 'environment' } };

    // Tenta iniciar. Se falhar com facingMode exact, tenta sem exact (compatibilidade)
    try{
      await S.html5QrcodeScanner.start(cameraConfig, { fps: 10, qrbox: 250 },
        (decoded) => { try{ if(typeof onScanSuccess === 'function') onScanSuccess(decoded); }catch(e){ console.error(e); } },
        (err) => {}
      );
    }catch(startErr){
      console.warn('start with chosen camera failed, trying fallback...', startErr);
      // √∫ltimo recurso: tentar sem constraints (deixa o browser escolher)
      try{
        await S.html5QrcodeScanner.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 }, onScanSuccess, (err)=>{});
      }catch(finalErr){
        console.error('failed to start scanner (global)', finalErr);
        const res = document.getElementById('scanResult');
        if(res) res.textContent = 'N√£o foi poss√≠vel iniciar a c√¢mera: ' + (finalErr && finalErr.message ? finalErr.message : finalErr);
      }
    }
  }catch(e){
    console.warn('startGlobalScanner error', e);
    const res = document.getElementById('scanResult');
    if(res) res.textContent = 'N√£o foi poss√≠vel iniciar a c√¢mera: ' + (e && e.message ? e.message : '');
  }
}


  async function stopToolScanner(){
    try{ await safeStop(S.toolScanner); }catch(e){ console.warn(e); }
    S.toolScanner = null;
    const el = document.getElementById('toolScanReader');
    if(el) el.innerHTML = '';
  }

  
async function startToolScanner(){
  const el = document.getElementById('toolScanReader');
  if(!el) return;
  await stopToolScanner();
  try{
    S.toolScanner = new Html5Qrcode('toolScanReader');

    let chosen = null;
    try{
      const cams = await Html5Qrcode.getCameras();
      if(cams && cams.length){
        const prefer = cams.find(c => /back|rear|traseira|environment/i.test(c.label || ''));
        const fallback = cams[cams.length-1];
        chosen = prefer || fallback || cams[0];
        console.log('Available cameras (tool):', cams, 'chosen:', chosen);
      }
    }catch(e){
      console.warn('getCameras failed (tool)', e);
    }

    let cameraConfig = null;
    if(chosen && chosen.id) cameraConfig = chosen.id;
    else cameraConfig = { facingMode: { exact: 'environment' } };

    try{
      await S.toolScanner.start(cameraConfig, { fps:10, qrbox:220 }, onToolScanSuccess, (err)=>{});
    }catch(startErr){
      console.warn('startToolScanner try fallback', startErr);
      try{
        await S.toolScanner.start({ facingMode: 'environment' }, { fps:10, qrbox:220 }, onToolScanSuccess, (err)=>{});
      }catch(finalErr){
        const msg = document.getElementById('toolScanMsg');
        if(msg) msg.innerHTML = '<span class="text-danger">N√£o foi poss√≠vel iniciar a c√¢mera. ' + (finalErr && finalErr.message ? finalErr.message : finalErr) + '</span>';
        console.warn('startToolScanner error', finalErr);
      }
    }
  }catch(e){
    const msg = document.getElementById('toolScanMsg');
    if(msg) msg.innerHTML = '<span class="text-danger">N√£o foi poss√≠vel iniciar a c√¢mera. ' + (e && e.message ? e.message : '') + '</span>';
    console.warn('startToolScanner error', e);
  }
}


  async function stopFillScanner(){
    try{ await safeStop(S.fillCodeScanner); }catch(e){ console.warn(e); }
    S.fillCodeScanner = null;
    const temp = document.getElementById('toolScanTemp');
    if(temp) temp.innerHTML = '';
  }

  // Expose functions (override existing names)
  window.startScanner = startGlobalScanner;
  window.stopScanner = stopGlobalScanner;
  window.startToolScanner = startToolScanner;
  window.stopToolScanner = stopToolScanner;
  window.stopFillCodeScanner = stopFillScanner;
  window.stopFillScanner = stopFillScanner; // alias

  // ensure cleanup on lifecycle events
  window.addEventListener('pagehide', async ()=>{ await stopGlobalScanner(); await stopToolScanner(); await stopFillScanner(); });
  window.addEventListener('beforeunload', async ()=>{ await stopGlobalScanner(); await stopToolScanner(); await stopFillScanner(); });
  document.addEventListener('visibilitychange', async ()=>{ if(document.visibilityState === 'hidden'){ await stopGlobalScanner(); await stopToolScanner(); } });

  // If scanner container exists and previously an instance was created, ensure it's cleared
  document.addEventListener('DOMContentLoaded', function(){
    try{ 
      if(document.getElementById('reader')) { /* do not auto-start here to respect original logic */ }
    }catch(e){ console.warn(e); }
  });
})();
</script>
<!-- End injected script -->


<script>
// Logo file picker: reads selected image as DataURL, updates cfgLogo value and preview, and calls applyBrand()
(function(){
  const fileInput = document.getElementById('cfgLogoFile');
  const urlInput = document.getElementById('cfgLogo');
  const preview = document.getElementById('cfgLogoPreview');
  const info = document.getElementById('cfgLogoInfo');
  if(!fileInput || !urlInput) return;
  fileInput.addEventListener('change', function(e){
    const file = fileInput.files && fileInput.files[0];
    if(!file) return;
    if(file.size > 2_500_000){ alert('Arquivo muito grande. Selecione uma imagem menor que 2.5MB.'); fileInput.value = ''; return; }
    const reader = new FileReader();
    reader.onload = function(ev){
      const dataUrl = ev.target.result;
      urlInput.value = dataUrl;
      preview.src = dataUrl;
      preview.style.display = 'inline-block';
      info.textContent = 'Arquivo selecionado (salve as configura√ß√µes para manter).';
      try{ if(typeof applyBrand === 'function') applyBrand(); }catch(e){ console.warn(e); }
    };
    reader.readAsDataURL(file);
  });
  urlInput.addEventListener('change', function(){
    const v = urlInput.value.trim();
    if(!v){ preview.style.display='none'; info.textContent = 'Cole uma URL ou selecione um arquivo (max ~2MB).'; return; }
    if(v.startsWith('data:')){ preview.src = v; preview.style.display='inline-block'; info.textContent = 'Imagem embutida pronta.'; try{ if(typeof applyBrand === 'function') applyBrand(); }catch(e){}; return; }
    preview.style.display='none'; info.textContent = 'Carregando preview...'; const img = new Image();
    img.onload = function(){ preview.src = v; preview.style.display='inline-block'; info.textContent = 'Imagem externa carregada.'; try{ if(typeof applyBrand === 'function') applyBrand(); }catch(e){}; };
    img.onerror = function(){ preview.style.display='none'; info.textContent = 'N√£o foi poss√≠vel carregar a imagem. Verifique a URL ou selecione um arquivo.'; };
    img.src = v;
  });
  document.addEventListener('DOMContentLoaded', function(){
    const v = urlInput.value && urlInput.value.trim();
    if(v){
      if(v.startsWith('data:')){ preview.src = v; preview.style.display='inline-block'; info.textContent = 'Preview de imagem embutida.'; }
      else {
        const img = new Image();
        img.onload = function(){ preview.src = v; preview.style.display='inline-block'; info.textContent = 'Preview de imagem externa.'; };
        img.onerror = function(){ preview.style.display='none'; info.textContent = 'URL do logo inv√°lida.'; };
        img.src = v;
      }
    }
  });
})();
</script>


<script>
function handleCameraError(err) {
  console.warn('camera error', err);
  const out = document.getElementById('scanResult') || document.body;

  if (err && err.name === 'NotAllowedError') {
    out.innerHTML = `
      <strong>Permiss√£o negada</strong><br>
      O navegador n√£o permitiu acesso √† c√¢mera.<br>
      1) Verifique as permiss√µes do navegador (Configura√ß√µes ‚Üí Permiss√µes ‚Üí C√¢mera).<br>
      2) Se estiver em um app/webview, confirme que o app repassa permiss√µes √† WebView.<br>
      3) Garanta que voc√™ est√° em <strong>HTTPS</strong> ou em <em>localhost</em>.
    `;
  } else if (err && err.name === 'NotFoundError') {
    out.innerHTML = 'Nenhuma c√¢mera encontrada neste dispositivo.';
  } else if (err && err.name === 'NotReadableError') {
    out.innerHTML = 'C√¢mera ocupada ‚Äî feche outros apps usando a c√¢mera.';
  } else {
    out.innerHTML = 'N√£o foi poss√≠vel iniciar a c√¢mera: ' + (err && err.message ? err.message : err);
  }
}
</script>


<!-- SCAN FEEDBACK: beep, vibrate and visual micro-animation -->
<style>
/* visual flash when scan succeeds */
.scan-success-flash {
  position: relative;
  box-shadow: 0 0 0 rgba(0,0,0,0);
  transition: box-shadow 220ms ease-out, transform 200ms ease-out;
}
.scan-success-flash.flash {
  box-shadow: 0 0 24px rgba(46, 204, 113, 0.95);
  transform: scale(1.01);
}
.scan-success-toast {
  position: absolute;
  top: 8px;
  left: 8px;
  background: rgba(46,204,113,0.95);
  color: #003300;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight:700;
  font-size:13px;
  display:none;
  z-index:9999;
}
.scan-success-toast.show{ display:block; animation: fadeOut 1500ms forwards 400ms; }
@keyframes fadeOut { from {opacity:1} to {opacity:0; transform: translateY(-8px);} }
</style>

<script>
(function(){
  // playBeep: use WebAudio for small beep; if blocked, try <audio> fallback
  function playBeep() {
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if(!AudioCtx) throw new Error('No AudioContext');
      const ctx = new AudioCtx();
      // resume context if needed (user gesture)
      if (ctx.state === 'suspended' && typeof ctx.resume === 'function') {
        ctx.resume().catch(()=>{});
      }
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 1000;
      g.gain.value = 0.0001;
      o.connect(g);
      g.connect(ctx.destination);
      const now = ctx.currentTime;
      // ramp to audible quickly and ramp down
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
      o.start(now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
      o.stop(now + 0.13);
      // close context after short delay to free resources
      setTimeout(()=>{ try{ if(ctx.close) ctx.close(); }catch(e){} }, 500);
    }catch(e){
      // fallback to audio element
      try{
        let a = document.getElementById('scanBeepAudio');
        if(!a){
          a = document.createElement('audio');
          a.id = 'scanBeepAudio';
          a.preload = 'auto';
          // small base64 beep (very short) - generated tone
          a.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=';
          document.body.appendChild(a);
        }
        a.currentTime = 0;
        a.play().catch(()=>{});
      }catch(err){ console.warn('beep fallback failed', err); }
    }
    // vibrate if supported
    try{
      if(navigator.vibrate) navigator.vibrate(80);
    }catch(e){}
  }

  // Visual micro-animation: flash and brief toast
  function animateScanSuccess(targetSelectors){
    try{
      const targets = Array.isArray(targetSelectors) ? targetSelectors : [targetSelectors || '#reader', '#toolScanReader'];
      targets.forEach(sel => {
        const el = document.querySelector(sel);
        if(!el) return;
        el.classList.add('scan-success-flash');
        // add toast if not present
        let toast = el.querySelector('.scan-success-toast');
        if(!toast){
          toast = document.createElement('div');
          toast.className = 'scan-success-toast';
          toast.textContent = 'Lido com sucesso';
          el.style.position = el.style.position || 'relative';
          el.appendChild(toast);
        }
        // trigger flash
        el.classList.add('flash');
        toast.classList.add('show');
        setTimeout(()=>{ el.classList.remove('flash'); toast.classList.remove('show'); }, 900);
      });
    }catch(e){ console.warn('animateScanSuccess', e); }
  }

  // Public API
  window.playBeep = playBeep;
  window.animateScanSuccess = animateScanSuccess;

  // Wrap existing handlers if present, otherwise create them
  function wrapHandler(name, selector){
    try{
      const original = window[name];
      if(typeof original === 'function'){
        window[name] = function(data){
          try{ playBeep(); animateScanSuccess(selector); }catch(e){}
          try{ return original.apply(this, arguments); }catch(e){ console.error('wrapped handler error', e); }
        };
      } else {
        // create default handler that just plays beep + logs
        window[name] = function(data){
          try{ playBeep(); animateScanSuccess(selector); }catch(e){};
          console.log(name, '=>', data);
        };
      }
    }catch(e){ console.warn('wrapHandler', e); }
  }

  // wrap both global scanner success handlers
  wrapHandler('onScanSuccess', '#reader');
  wrapHandler('onToolScanSuccess', '#toolScanReader');

  // For Html5Qrcode callbacks that might be passed directly (if the code referenced local functions),
  // you can also add a small adapter: if S.html5QrcodeScanner exists and has start called later, ensure
  // the success callbacks call playBeep. But our wrapping of global handlers above should cover most cases.

  // Small helper: enable beep after a user gesture if context is suspended
  document.addEventListener('click', function enableAudioOnFirstGesture(){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if(AudioCtx){
        const ctx = new AudioCtx();
        if(ctx.state === 'suspended' && typeof ctx.resume === 'function'){
          ctx.resume().catch(()=>{});
        }
        try{ if(ctx.close) ctx.close(); }catch(e){};
      }
    }catch(e){};
    document.removeEventListener('click', enableAudioOnFirstGesture);
  });
})();
</script>
<!-- END SCAN FEEDBACK -->


<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Welcome & Chart logic -->
<script>
(function(){
  // utility: safe text insertion
  function setText(id, txt){
    var el = document.getElementById(id);
    if(!el) return;
    el.textContent = txt || '';
  }

  // Attempt to find session user from existing app structures:
  var sessionUser = null;
  try {
    // common patterns: window.session, session, currentUser, fi_session
    if(window.session && window.session.user) sessionUser = window.session.user;
    else if(window.fi_session && window.fi_session.user) sessionUser = window.fi_session.user;
    else if(window.currentUser) sessionUser = window.currentUser;
    else {
      // try reading from localStorage if app stores 'fi_users' or 'session'
      var sess = localStorage.getItem('session') || localStorage.getItem('fi_session') || localStorage.getItem('fi_users');
      if(sess){
        try{
          var parsed = JSON.parse(sess);
          if(parsed && parsed.user) sessionUser = parsed.user;
        }catch(e){}
      }
    }
  } catch(e){ console.warn('session detection failed', e); }

  // Show welcome banner if we have a user or if app sets current session later, watch for changes
  function showWelcomeIfReady(){
    var banner = document.getElementById('welcomeBanner');
    var chartCard = document.getElementById('itemsChartCard');
    if(!banner || !chartCard) return;
    // Determine displayName
    var name = (sessionUser && (sessionUser.displayName || sessionUser.name || sessionUser.email)) || null;
    if(!name){
      // try to derive from login input if present
      var uname = document.querySelector('input[name="email"], input#email, input[name="user"]');
      if(uname) name = uname.value || uname.placeholder || null;
    }
    if(name){
      \1
      
// Avatar initials
var avatarEl = document.getElementById('welcomeAvatar');
if(name && avatarEl){
  var initials = name.trim().split(' ').map(w => w[0]).slice(0,2).join('').toUpperCase();
  avatarEl.textContent = initials || 'U';
}

      banner.style.display = 'flex';
    } else {
      // fallback: show generico
      document.getElementById('welcomeName').textContent = 'Usu√°rio';
      banner.style.display = 'flex';
    }
    chartCard.style.display = 'block';
  }

  // Hook into loans rendering: we will override the function that renders loans if it exists,
  // otherwise we will post-process the loans list after it's rendered.
  function enhanceLoansRender(){
    // Try common function names or DOM ids used in the app
    // We'll look for an element with id 'loanList' or class 'loan-list' and append borrower names if missing.
    var loanContainers = document.querySelectorAll('#loanList, .loan-list, #loansContainer, #emprestimosList');
    if(loanContainers && loanContainers.length){
      loanContainers.forEach(function(container){
        // For each loan item (assume data-loan-id attribute or li elements)
        var items = container.querySelectorAll('[data-loan-id], li, .loan-item');
        items.forEach(function(it){
          // avoid duplicating name
          if(it.querySelector('.borrower-name')) return;
          // attempt to read loan data from dataset or child nodes
          var borrower = null;
          try {
            if(it.dataset && it.dataset.userName) borrower = it.dataset.userName;
            else {
              // try to find user id and map to users in localStorage
              var uid = it.dataset.userId || it.getAttribute('data-user-id');
              if(uid){
                var users = JSON.parse(localStorage.getItem('fi_users') || '[]');
                var found = users.find(function(u){ return u && (u.id==uid || u.email==uid || u.userId==uid || u.uid==uid); });
                if(found) borrower = found.displayName || found.name || found.email;
              }
            }
          } catch(e){}
          if(!borrower){
            // fallback: try to read text 'Emprestado por:' inside item
            var match = it.textContent.match(/Emprestad[o|a] por[:\s]+([\w\s@\.\-]+)/i);
            if(match) borrower = match[1].trim();
          }
          if(!borrower){
            // if app stores loans in localStorage, try to map by loan id
            var loanId = it.dataset.loanId || it.getAttribute('data-loan-id');
            if(loanId){
              try{
                var state = JSON.parse(localStorage.getItem('fi_state') || localStorage.getItem('fi_data') || '{}');
                var loans = state.loans || JSON.parse(localStorage.getItem('fi_loans')||'[]');
                var loan = (loans || []).find(function(l){ return l && (l.id==loanId || l.loanId==loanId); });
                if(loan){
                  borrower = loan.userName || loan.userDisplay || loan.user || loan.userId;
                }
              }catch(e){}
            }
          }
          if(borrower){
            var span = document.createElement('span');
            span.className = 'borrower-name';
            span.style.marginLeft='8px';
            span.style.fontWeight='600';
            span.style.color='#1b6fb8';
            span.textContent = `‚Äî ${borrower}`;
            // append to title or first child
            var target = it.querySelector('.title, .tool-name') || it.firstElementChild || it;
            target.appendChild(span);
          }
        });
      });
    }
  }

  // Build chart summarizing tools: counts of available vs loaned
  function buildItemsChart(){
    var ctx = document.getElementById('itemsChart');
    if(!ctx) return;
    // collect tools and loans from localStorage
    var tools = [];
    var loans = [];
    try{
      tools = JSON.parse(localStorage.getItem('fi_tools') || localStorage.getItem('tools') || '[]') || [];
    }catch(e){ tools = []; }
    try{
      loans = JSON.parse(localStorage.getItem('fi_loans') || localStorage.getItem('loans') || '[]') || [];
    }catch(e){ loans = []; }

    // if app stores combined state
    try{
      var state = JSON.parse(localStorage.getItem('fi_state') || '{}');
      if(state && state.tools) tools = state.tools;
      if(state && state.loans) loans = state.loans;
    }catch(e){}

    // compute counts by status
    var total = tools.length || 0;
    // consider loaned tools by checking loans with returnDate null/undefined
    var loanedIds = (loans||[]).filter(function(l){ return !l.returnDate && !l.returned; }).map(function(l){ return l.toolId || l.tool || l.id; });
    var loanedCount = loanedIds.length;
    var availableCount = Math.max(0, total - loanedCount);

    // categorize by tag/type if present (optional)
    // create chart
    try{
      // destroy previous chart if exists
      if(window.__toolsChartInstance){
        window.__toolsChartInstance.destroy();
        window.__toolsChartInstance = null;
      }
      window.__toolsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Total', 'Emprestadas', 'Dispon√≠veis'],
          datasets: [{
            label: 'Quantidade',
            data: [total, loanedCount, availableCount],
            // leave default colors (do not force)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { precision:0 } }
          }
        }
      });
    }catch(e){ console.warn('chart build failed', e); }
  }

  // run after DOM ready
  document.addEventListener('DOMContentLoaded', function(){
    // try to detect or wait for app initialization
    showWelcomeIfReady();
    enhanceLoansRender();
    buildItemsChart();

    // also run after minor delays to catch dynamic renders
    setTimeout(function(){ enhanceLoansRender(); buildItemsChart(); }, 800);
    setTimeout(function(){ enhanceLoansRender(); buildItemsChart(); }, 2000);

    // observe localStorage changes (loans/tools updates) and update chart/render accordingly
    window.addEventListener('storage', function(e){
      if(e.key && (e.key.includes('loan') || e.key.includes('tool') || e.key.includes('fi_state'))){
        enhanceLoansRender();
        buildItemsChart();
      }
    });
  });

  // Expose for manual refresh
  window.AppExtras = {
    refreshLoansView: enhanceLoansRender,
    refreshItemsChart: buildItemsChart
  };
})();
</script>
<!-- /Welcome & Chart logic -->


<!-- Return photo handling -->
<script>
(function(){
  function readFileAsDataURL(file){
    return new Promise(function(res, rej){
      var reader = new FileReader();
      reader.onload = function(){ res(reader.result); };
      reader.onerror = function(e){ rej(e); };
      reader.readAsDataURL(file);
    });
  }

  function setupPhotoControls(modalRoot){
    var input = modalRoot.querySelector('#returnPhotoInput') || document.getElementById('returnPhotoInput');
    var previewWrap = modalRoot.querySelector('#returnPhotoPreview') || document.getElementById('returnPhotoPreview');
    var img = modalRoot.querySelector('#returnPhotoImg') || document.getElementById('returnPhotoImg');
    var clearBtn = modalRoot.querySelector('#clearReturnPhoto') || document.getElementById('clearReturnPhoto');

    if(!input) return;

    input.addEventListener('change', async function(e){
      var file = input.files && input.files[0];
      if(!file) {
        if(previewWrap) previewWrap.style.display='none';
        return;
      }
      try{
        var dataUrl = await readFileAsDataURL(file);
        if(img){ img.src = dataUrl; }
        if(previewWrap){ previewWrap.style.display = 'block'; }
      }catch(err){
        console.warn('leitura da foto falhou', err);
      }
    });

    if(clearBtn){
      clearBtn.addEventListener('click', function(){
        input.value = '';
        if(img) img.src = '';
        if(previewWrap) previewWrap.style.display = 'none';
      });
    }
  }

  // Try to find modal confirm button(s) and hook into return action.
  function hookReturnConfirm(){
    // Possible selectors for confirm button
    var selectors = [
      'button[data-action="confirmReturn"]',
      'button[data-action="devolver"]',
      'button#btnConfirmReturn',
      'button#confirmReturn',
      'button:contains("Confirmar")',
      'button:contains("Devolver")',
      '.modal .btn-primary'
    ];
    // Because :contains isn't standard, we'll iterate buttons and check textContent as fallback
    var allButtons = Array.from(document.querySelectorAll('button'));
    allButtons.forEach(function(btn){
      var txt = (btn.textContent || '').trim().toLowerCase();
      if(!txt) return;
      if(txt.includes('devolver') || txt.includes('confirmar') || txt.includes('registrar devolu√ß√£o') || txt.includes('finalizar devol') ){
        // attach handler if not already attached
        if(btn.__photoHookAttached) return;
        btn.addEventListener('click', function(ev){
          try{
            handleReturnConfirmation(ev, btn);
          }catch(e){ console.error('handleReturnConfirmation error', e); }
        });
        btn.__photoHookAttached = true;
      }
    });
  }

  // Locate current loan id from modal or page context
  function detectLoanIdFromModal(modalRoot){
    if(!modalRoot) return null;
    // common patterns: data-loan-id attribute, hidden input, text like "Loan ID: 123"
    var loanId = modalRoot.getAttribute('data-loan-id') || modalRoot.dataset.loanId;
    if(!loanId){
      var hidden = modalRoot.querySelector('input[type="hidden"][name*="loan"], input[type="hidden"][id*="loan"]');
      if(hidden) loanId = hidden.value;
    }
    if(!loanId){
      // try to find element with id 'currentLoanId'
      var el = document.getElementById('currentLoanId') || document.querySelector('[data-current-loan-id]');
      if(el) loanId = el.value || el.getAttribute('data-current-loan-id') || el.dataset.currentLoanId;
    }
    return loanId;
  }

  // Main handler when confirm return clicked
  async function handleReturnConfirmation(ev, btn){
    // find modal ancestor
    var modal = btn.closest('.modal') || document.querySelector('.modal.show') || document.querySelector('.modal');
    if(!modal){
      // fallback: use document
      modal = document;
    }
    // ensure photo controls are set up
    setupPhotoControls(modal);

    var input = modal.querySelector('#returnPhotoInput') || document.getElementById('returnPhotoInput');
    var file = input && input.files && input.files[0];
    var dataUrl = null;
    if(file){
      try{
        dataUrl = await readFileAsDataURL(file);
      }catch(e){
        console.warn('erro ao ler foto', e);
      }
    }

    // now attach dataUrl to loan object in localStorage
    try{
      // try multiple storage keys
      var stateKeys = ['fi_state', 'fi_loans', 'fi_loans_backup', 'loans', 'fi_state_backup'];
      var loanId = detectLoanIdFromModal(modal);

      // if not found, try to infer from selected loan element in modal content
      if(!loanId){
        // look for text 'Emprestimo' or pattern 'ID:' inside modal
        var txt = modal.textContent || '';
        var m = txt.match(/\\b(?:ID|Id|id)[:\\s]+(\\d{1,8})\\b/);
        if(m) loanId = m[1];
      }

      // load loans list
      var loans = null;
      // check nested state fi_state
      var s = localStorage.getItem('fi_state');
      if(s){
        try{ var parsed = JSON.parse(s); if(parsed && parsed.loans) loans = parsed.loans; }catch(e){}
      }
      if(!loans){
        var s2 = localStorage.getItem('fi_loans') || localStorage.getItem('loans');
        if(s2){
          try{ loans = JSON.parse(s2); }catch(e){}
        }
      }
      if(!loans) loans = [];

      // find loan by id or by tool id present in modal
      var loan = null;
      if(loanId){
        loan = loans.find(function(l){ return l && (String(l.id)===String(loanId) || String(l.loanId)===String(loanId) || String(l._id)===String(loanId)); });
      }
      if(!loan){
        // try to find loan where toolId matches some displayed tool identifier in modal
        var possibleToolText = (modal.textContent || '').match(/[A-Za-z0-9\\-\\_]{3,}/g);
        if(possibleToolText){
          // naive: pick first loan without returnDate
          loan = loans.find(function(l){ return l && (!l.returnDate && !l.returned); });
        }
      }

      if(!loan){
        // give up gracefully
        // but still persist photo to a 'returns_pending_photos' area in localStorage keyed by timestamp
        if(dataUrl){
          var pending = JSON.parse(localStorage.getItem('returns_pending_photos')||'[]');
          pending.push({ ts: Date.now(), photo: dataUrl, modalText: (modal.textContent||'').slice(0,300) });
          localStorage.setItem('returns_pending_photos', JSON.stringify(pending));
          console.info('Foto salva em returns_pending_photos (loan n√£o identificado).');
        }
      } else {
        // attach to loan.returnPhotos array
        loan.returnPhotos = loan.returnPhotos || [];
        if(dataUrl) loan.returnPhotos.push({ ts: Date.now(), data: dataUrl });
        // mark returned flag if not set (we won't change returnDate here; we only attach photo)
        // persist back into same storage structure we found
        // try to persist into fi_state if exists
        var persisted = false;
        var sfi = localStorage.getItem('fi_state');
        if(sfi){
          try{
            var st = JSON.parse(sfi);
            if(st && st.loans){
              var idx = st.loans.findIndex(function(x){ return String(x.id)===String(loan.id) || String(x.loanId)===String(loan.loanId); });
              if(idx>-1){ st.loans[idx] = loan; localStorage.setItem('fi_state', JSON.stringify(st)); persisted = true; }
            }
          }catch(e){}
        }
        if(!persisted){
          // try fi_loans
          var s2 = localStorage.getItem('fi_loans') || localStorage.getItem('loans');
          if(s2){
            try{
              var arr = JSON.parse(s2);
              var idx2 = arr.findIndex(function(x){ return String(x.id)===String(loan.id) || String(x.loanId)===String(loan.loanId); });
              if(idx2>-1){ arr[idx2] = loan; localStorage.setItem('fi_loans', JSON.stringify(arr)); persisted = true; }
            }catch(e){}
          }
        }
        if(!persisted){
          // fallback: save loans back if we have loans array reference
          try{
            var idx3 = loans.findIndex(function(x){ return String(x.id)===String(loan.id) || String(x.loanId)===String(loan.loanId); });
            if(idx3>-1){ loans[idx3] = loan; localStorage.setItem('fi_loans', JSON.stringify(loans)); persisted = true; }
          }catch(e){}
        }
        console.info('Foto anexada ao empr√©stimo', loan.id || loan.loanId || '(sem id)');
      }
    }catch(e){
      console.error('erro ao anexar foto', e);
    }

    // allow original click to continue (so existing return logic runs). We do not preventDefault.
  }

  // Utility to find elements by text (polyfill for :contains)
  function elementsContainingText(selector, text){
    var els = Array.from(document.querySelectorAll(selector));
    return els.filter(function(el){ return (el.textContent||'').toLowerCase().includes(text.toLowerCase()); });
  }

  // Initialize: setup controls in modals found, and hook confirm buttons
  document.addEventListener('DOMContentLoaded', function(){
    // find modal(s) containing "Devolu√ß√£o" or "Condi√ß√£o"
    var modals = Array.from(document.querySelectorAll('.modal')).filter(function(m){
      var txt = (m.textContent||'').toLowerCase();
      return txt.includes('devolu') || txt.includes('condi√ß√£o') || txt.includes('condicao');
    });
    if(modals.length){
      modals.forEach(function(m){
        // if it doesn't already contain our photo section, try to append
        if(!m.querySelector('#returnPhotoInput') && document.getElementById('returnPhotoSection')){
          try{
            var sect = document.getElementById('returnPhotoSection');
            m.querySelector('.modal-body')?.appendChild(sect);
            sect.style.display = 'block';
          }catch(e){ /* ignore */ }
        }
        setupPhotoControls(m);
      });
    } else {
      // if no modal found, also setup controls on fallback area
      setupPhotoControls(document);
    }

    // Hook confirm buttons (initial)
    hookReturnConfirm();

    // Also observe DOM changes to attach when modal opens dynamically
    var obs = new MutationObserver(function(muts){
      hookReturnConfirm();
    });
    obs.observe(document.body, { childList:true, subtree:true });
  });

  // expose for debug
  window.ReturnPhotoHelper = { setupPhotoControls: setupPhotoControls, hookReturnConfirm: hookReturnConfirm };
})();
</script>
<!-- /Return photo handling -->


<!-- Dynamic injection for return photo when modal titled "Devolu√ß√£o - Condi√ß√£o da ferramenta" opens -->
<script>
(function(){
  function createPhotoSection(){
    var container = document.createElement('div');
    container.id = 'returnPhotoSectionDynamic';
    container.style.marginTop = '10px';
    container.innerHTML = '\
      <label style="display:block; font-weight:600; margin-bottom:6px;">Registro fotogr√°fico</label>\
      <input type="file" id="returnPhotoInputDynamic" accept="image/*" capture="environment" style="display:block; margin-bottom:8px;" />      <div style="margin-top:6px;"><button type="button" id="openCameraButtonDynamic" style="padding:6px 8px; border-radius:6px;">Abrir c√¢mera</button></div>\
      <div id="returnPhotoPreviewDynamic" style="display:none; margin-top:6px;">\
        <img id="returnPhotoImgDynamic" src="" alt="Preview foto" style="max-width:220px; border-radius:6px; border:1px solid #ddd;" />\
        <div><button type="button" id="clearReturnPhotoDynamic" style="margin-top:6px;">Remover foto</button></div>\
      </div>';
    return container;
  }

  function setupControls(root){
    if(!root) root = document;
    var input = root.querySelector('#returnPhotoInputDynamic') || document.getElementById('returnPhotoInputDynamic');
    var preview = root.querySelector('#returnPhotoPreviewDynamic') || document.getElementById('returnPhotoPreviewDynamic');
    var img = root.querySelector('#returnPhotoImgDynamic') || document.getElementById('returnPhotoImgDynamic');
    var clearBtn = root.querySelector('#clearReturnPhotoDynamic') || document.getElementById('clearReturnPhotoDynamic');
    if(!input) return;

    input.addEventListener('change', function(){
      var file = input.files && input.files[0];
      if(!file){
        if(preview) preview.style.display = 'none';
        return;
      }
      var reader = new FileReader();
      reader.onload = function(e){
        if(img) img.src = e.target.result;
        if(preview) preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    if(clearBtn){
      clearBtn.addEventListener('click', function(){
        input.value = '';
        if(img) img.src = '';
        if(preview) preview.style.display = 'none';
      });
    }
  }

  function requirePhotoIfDamaged(root){
    // find condition selector/radios/inputs inside modal and attach change listeners
    if(!root) root = document;
    var labels = ['sujo','danificado','danificada','danificado(a)','danificad'];
    var inputs = Array.from(root.querySelectorAll('input[type="radio"], input[type="checkbox"], select'));
    inputs.forEach(function(inp){
      // for selects
      if(inp.tagName.toLowerCase()==='select'){
        inp.addEventListener('change', function(){
          var val = (inp.value||'').toLowerCase();
          var need = labels.some(function(l){ return val.includes(l); });
          inp.dataset.photoRequired = need ? '1' : '0';
        });
      } else {
        // radio/checkbox
        inp.addEventListener('change', function(){
          // evaluate all radios with the same name and the selected one
          try{
            var name = inp.name;
            if(name){
              var chosen = document.querySelector('input[name="'+name+'"]:checked');
              if(chosen){
                var val = (chosen.value||chosen.dataset.value||chosen.labels?.[0]?.textContent||'').toLowerCase();
                var need = labels.some(function(l){ return val.includes(l); });
                // store on modal root for checking
                root.dataset.photoRequired = need ? '1' : '0';
              }
            }
          }catch(e){}
        });
      }
    });
  }

  function attachValidationToConfirm(root){
    if(!root) root = document;
    // find confirm buttons (heuristic)
    var btns = Array.from(root.querySelectorAll('button'));
    btns.forEach(function(b){
      var txt = (b.textContent||'').trim().toLowerCase();
      if(!txt) return;
      if(txt.includes('devolver') || txt.includes('confirmar') || txt.includes('finalizar') || txt.includes('registrar')){
        if(b.__photoValidationAttached) return;
        b.addEventListener('click', function(ev){
          try{
            // find modal root
            var modal = b.closest('.modal') || root.closest('.modal') || document.querySelector('.modal.show') || document.querySelector('.modal');
            if(!modal) modal = root;
            // determine if photo required
            var required = false;
            // check modal.dataset first (set by requirePhotoIfDamaged)
            if(modal && modal.dataset && modal.dataset.photoRequired==='1') required = true;
            // also check selects/radios one more time
            try{
              var sel = modal.querySelector('select');
              if(sel){
                var val = (sel.value||'').toLowerCase();
                if(['sujo','danificado','danificada','danificad'].some(function(l){ return val.includes(l); })) required = true;
              }
              var chosen = modal.querySelector('input[type="radio"]:checked');
              if(chosen){
                var v = (chosen.value||chosen.dataset.value||chosen.labels?.[0]?.textContent||'').toLowerCase();
                if(['sujo','danificado','danificada','danificad'].some(function(l){ return v.includes(l); })) required = true;
              }
            }catch(e){}
            // if required, ensure photo present
            if(required){
              var input = modal.querySelector('#returnPhotoInputDynamic') || document.getElementById('returnPhotoInputDynamic');
              var hasFile = input && input.files && input.files.length>0;
              if(!hasFile){
                ev.preventDefault();
                ev.stopPropagation();
                // visual feedback
                alert('Por favor, adicione uma foto como registro: a condi√ß√£o selecionada exige registro fotogr√°fico.');
                // focus the input
                if(input) input.focus();
                return false;
              }
            }
            // otherwise allow original click to proceed
          }catch(err){
            console.error('Valida√ß√£o foto devolu√ß√£o erro', err);
          }
        }, {capture:false});
        b.__photoValidationAttached = true;
      }
    });
  }

  // Main: detect modal open that matches title text
  
// Auto-open camera when modal opens and when the condition requires a photo or always (best-effort).
function tryAutoOpenCamera(modal){
  try{
    var input = modal.querySelector('#returnPhotoInputDynamic') || document.getElementById('returnPhotoInputDynamic');
    var openBtn = modal.querySelector('#openCameraButtonDynamic') || document.getElementById('openCameraButtonDynamic');
    if(!input) return;
    // If input already has files, don't re-open
    if(input.files && input.files.length>0) return;
    // Attempt programmatic click (may be blocked on some browsers)
    var clicked = false;
    try{
      input.click();
      clicked = true;
    }catch(e){
      clicked = false;
    }
    // If not clicked (blocked), show the open camera button (or ensure it's visible)
    if(openBtn){
      openBtn.style.display = 'inline-block';
      openBtn.addEventListener('click', function(){ input.click(); });
      // also try to auto-click the button (some browsers may allow)
      try{ openBtn.click(); }catch(e){}
    }
  }catch(e){ console.warn('auto open camera failed', e); }
}

function handleNewModal(modal){
    if(!modal) return;
    try{
      var title = (modal.querySelector('.modal-title') && modal.querySelector('.modal-title').textContent) ||
                  (modal.querySelector('h5') && modal.querySelector('h5').textContent) ||
                  modal.textContent || '';
      if(!title) return;
      if(title.toLowerCase().includes('devolu√ß√£o - condi√ß√£o da ferramenta'.toLowerCase()) ||
         title.toLowerCase().includes('devolucao - condicao da ferramenta'.toLowerCase()) ||
         title.toLowerCase().includes('devolu√ß√£o') && title.toLowerCase().includes('condi')) {
        // insert photo section if not present
        if(!modal.querySelector('#returnPhotoSectionDynamic')){
          var body = modal.querySelector('.modal-body') || modal;
          var section = createPhotoSection();
          body.appendChild(section);
          setupControls(modal);
          requirePhotoIfDamaged(modal);
          attachValidationToConfirm(modal);
          tryAutoOpenCamera(modal);
        }
      }
    }catch(e){}
  }

  // Observe DOM for modal insertions/changes
  var obs = new MutationObserver(function(muts){
    muts.forEach(function(m){
      m.addedNodes.forEach(function(node){
        try{
          if(node.nodeType!==1) return;
          if(node.classList && node.classList.contains('modal')) handleNewModal(node);
          // also check descendants
          var modals = node.querySelectorAll && node.querySelectorAll('.modal');
          if(modals && modals.length){
            modals.forEach(function(mm){ handleNewModal(mm); });
          }
          // nodes that are generic containers: check if they contain the target title
          if(node.querySelector && (node.textContent||'').toLowerCase().includes('devolu') && (node.textContent||'').toLowerCase().includes('condi')){
            var nearestModal = node.closest('.modal') || node;
            handleNewModal(nearestModal);
          }
        }catch(e){}
      });
      // also check attribute changes that show modal (like class 'show')
      m.target && (function(t){
        if(t.classList && t.classList.contains('modal') && t.classList.contains('show')){
          handleNewModal(t);
        }
      })(m.target);
    });
  });
  obs.observe(document.body, { childList:true, subtree:true, attributes:true });

  // Also on DOMContentLoaded, scan any existing modals
  document.addEventListener('DOMContentLoaded', function(){
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(m){ handleNewModal(m); });
    // also attach validations periodically for dynamically created controls
    setInterval(function(){
      var visible = document.querySelectorAll('.modal.show, .modal[aria-hidden="false"]');
      visible.forEach(function(v){ handleNewModal(v); });
      attachValidationToConfirm(document);
    }, 800);
  });

})();
</script>
<!-- /Dynamic injection for return photo -->

</body>
</html>
